name: ALZ Bicep workflow deployment pipeline

on:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/deploy-alz-bicep-steps.yml"
  workflow_dispatch: {}
env:
  alzBicepRelease: "v0.19.4"
  ManagementGroupPrefix: "alz-bicep"
  ManagementGroupSuffix: "-canary01"
  TopLevelManagementGroupDisplayName: "ALZ-Bicep-Canary01"
  Location: "germanywestcentral"
  LoggingResourceGroupName: "rg-alz-bicep-canary01-logging-001"
  HubNetworkResourceGroupName: "rg-alz-bicep-canary01-hub-networking-001"
  HubNetworkAddressPrefix: "10.10.0.0/16"
  logAnalyticsWorkspaceName: "alz-log-analytics" 
  dataCollectionRuleVMInsightsName: "alz-ama-vmi-dcr" 
  dataCollectionRuleChangeTrackingName: "alz-ama-ct-dcr" 
  dataCollectionRuleMDFCSQLName: "alz-ama-mdfcsql-dcr" 
  userAssignedManagedIdentityName: "alz-logging-mi" 
  LoggingSubId: ${{ secrets.LOGGING_SUB_ID }}
  IdentitySubId: ${{ secrets.IDENTITY_SUB_ID }}
  MgmtSubId: ${{ secrets.MGMT_SUB_ID }}
  ConnectivitySubId: ${{ secrets.CONNECTIVITY_SUB_ID }}
  DefenderForCloudEmailSecurityContact: ${{ secrets.DFC_EMAIL_SECURITY_CONTACT }}
  RoleAssignmentManagementGroupId: "alz-bicep-platform-prod"
  SpokeNetworkSubId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  SpokeNetworkResourceGroupName: "Spoke_Networking_POC"
  runNumber: ${{ github.run_number }}

permissions:
  id-token: write
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Run lint job
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Run bicep linter
        run: |
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/managementGroups/managementGroups.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/customPolicyDefinitions.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/customRoleDefinitions.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/logging/logging.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/mgDiagSettingsAll.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep
          az bicep build --file ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/subPlacementAll.bicep
  validate_preview_create_mgs:
    runs-on: ubuntu-latest
    needs: [lint]
    name: Deploy Management Groups - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Management Groups - Validate
        id: deploy_mgs_validation
        shell: bash
        run: |
            az deployment tenant validate --template-file ALZ-Bicep/infra-as-code/bicep/modules/managementGroups/managementGroups.bicep \
            --parameters parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }} \
            --parameters parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }} \
            --parameters parTopLevelManagementGroupDisplayName="${{ env.TopLevelManagementGroupDisplayName }}" \
            --location ${{ env.Location }} --name deploy_mgs_validation-${{ env.runNumber }}
      - name: Deploy Management Groups - Preview
        id: deploy_mgs_preview
        shell: bash
        run: |
            az deployment tenant what-if --template-file ALZ-Bicep/infra-as-code/bicep/modules/managementGroups/managementGroups.bicep \
            --parameters parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }} \
            --parameters parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }} \
            --parameters parTopLevelManagementGroupDisplayName="${{ env.TopLevelManagementGroupDisplayName }}" \
            --location ${{ env.Location }} --name deploy_mgs_preview-${{ env.runNumber }}
  deploy_create_mgs:
    runs-on: ubuntu-latest
    needs: [lint,validate_preview_create_mgs]
    environment: deploy
    name: Deploy Management Groups - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Management Groups - Deployment
        id: deploy_mgs_deployment
        shell: bash
        run: |
            az deployment tenant create --template-file ALZ-Bicep/infra-as-code/bicep/modules/managementGroups/managementGroups.bicep \
            --parameters parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }} \
            --parameters parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }} \
            --parameters parTopLevelManagementGroupDisplayName="${{ env.TopLevelManagementGroupDisplayName }}" \
            --location ${{ env.Location }} --name deploy_mgs_deployment-${{ env.runNumber }}
  validate_preview_custom_policy_defs:
    runs-on: ubuntu-latest
    needs: [lint,deploy_create_mgs]
    name: Deploy Custom Policy Definitions - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Custom Policy Definitions - Validation
        id: deploy_custom_policy_defs_validation
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/customPolicyDefinitions.bicep
          parameters: ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/parameters/customPolicyDefinitions.parameters.all.json parTargetManagementGroupId=${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_custom_policy_defs_validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Custom Policy Definitions - Preview
        id: deploy_custom_policy_defs_preview
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/customPolicyDefinitions.bicep
          parameters: ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/parameters/customPolicyDefinitions.parameters.all.json parTargetManagementGroupId=${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_custom_policy_defs_preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_custom_policy_defs:
    runs-on: ubuntu-latest
    needs: [validate_preview_custom_policy_defs]
    environment: deploy  
    name: Deploy Custom Policy Definitions - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Custom Policy Definitions - Deploy
        id: deploy_custom_policy_defs_deploy
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/customPolicyDefinitions.bicep
          parameters: ALZ-Bicep/infra-as-code/bicep/modules/policy/definitions/parameters/customPolicyDefinitions.parameters.all.json parTargetManagementGroupId=${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_custom_policy_defs_deploy-${{ env.runNumber }}
          failOnStdErr: false
  validate_preview_custom_role_definitions:
    runs-on: ubuntu-latest
    needs: [lint,deploy_custom_policy_defs]
    name: Deploy Custom Role Definitions - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Custom Role Definitions - Validation
        id: deploy_custom_role_definitions_validation
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/customRoleDefinitions.bicep
          parameters: ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/parameters/customRoleDefinitions.parameters.all.json parAssignableScopeManagementGroupId=${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_custom_policy_defs_validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Custom Role Definitions - Preview
        id: deploy_custom_policy_defs_preview
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/customRoleDefinitions.bicep
          parameters: ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/parameters/customRoleDefinitions.parameters.all.json parAssignableScopeManagementGroupId=${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_custom_policy_defs_validation-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_custom_role_definitions:
    runs-on: ubuntu-latest
    needs: [validate_preview_custom_role_definitions]
    environment: deploy  
    name: Deploy Custom Role Definitions - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Custom Role Definitions - Deploy
        id: deploy_custom_role_definitions_deploy
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/customRoleDefinitions.bicep
          parameters: ALZ-Bicep/infra-as-code/bicep/modules/customRoleDefinitions/parameters/customRoleDefinitions.parameters.all.json parAssignableScopeManagementGroupId=${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_custom_policy_defs_validation-${{ env.runNumber }}
          failOnStdErr: false
  validate_preview_logging:
    runs-on: ubuntu-latest
    needs: [deploy_custom_role_definitions]
    name: Deploy Logging - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Logging RG - Validation
        id: deploy_logging_validation_rg
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ env.LoggingSubId }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          parameters: parResourceGroupName=${{ env.LoggingResourceGroupName }} parLocation=${{ env.Location }}
          deploymentName: create_logging_rg_validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Logging Resources - Validation
        id: deploy_logging_validation
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.LoggingSubId }}
          region: ${{ env.Location }}
          resourceGroupName: ${{ env.LoggingResourceGroupName }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/logging/logging.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/modules/logging/parameters/logging.parameters.all.json
            parLogAnalyticsWorkspaceLocation=${{env.Location}}
            parAutomationAccountLocation=${{env.Location}}
            parLogAnalyticsWorkspaceName=${{ env.logAnalyticsWorkspaceName}}
            parDataCollectionRuleMDFCSQLName=${{ env.dataCollectionRuleMDFCSQLName}}
            parDataCollectionRuleChangeTrackingName=${{ env.dataCollectionRuleChangeTrackingName}}
            parDataCollectionRuleVMInsightsName=${{ env.dataCollectionRuleVMInsightsName}}
            parUserAssignedManagedIdentityName=${{ env.userAssignedManagedIdentityName}}
          deploymentName: create_logging-validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Logging RG - Preview
        id: deploy_logging_preview_rg
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ env.LoggingSubId }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          parameters: parResourceGroupName=${{ env.LoggingResourceGroupName }} parLocation=${{ env.Location }}
          deploymentName: create_logging_rg_preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
      - name: Deploy Logging Resources - Preview
        id: deploy_logging_preview
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.LoggingSubId }}
          region: ${{ env.Location }}
          resourceGroupName: ${{ env.LoggingResourceGroupName }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/logging/logging.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/modules/logging/parameters/logging.parameters.all.json
            parLogAnalyticsWorkspaceLocation=${{env.Location}}
            parAutomationAccountLocation=${{env.Location}}
            parLogAnalyticsWorkspaceName=${{ env.logAnalyticsWorkspaceName}}
            parDataCollectionRuleMDFCSQLName=${{ env.dataCollectionRuleMDFCSQLName}}
            parDataCollectionRuleChangeTrackingName=${{ env.dataCollectionRuleChangeTrackingName}}
            parDataCollectionRuleVMInsightsName=${{ env.dataCollectionRuleVMInsightsName}}
            parUserAssignedManagedIdentityName=${{ env.userAssignedManagedIdentityName}}
          deploymentName: create_logging-preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_logging:
    runs-on: ubuntu-latest
    needs: [validate_preview_logging]
    environment: deploy
    name: Deploy Logging - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Logging RG - Deployment
        id: deploy_logging_rg_deploy
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ env.LoggingSubId }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          parameters: parResourceGroupName=${{ env.LoggingResourceGroupName }} parLocation=${{ env.Location }}
          deploymentName: create_logging_rg_deploy-${{ env.runNumber }}
          failOnStdErr: false
      - name: Deploy Logging Resources - Deployment
        id: deploy_logging_deployment
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.LoggingSubId }}
          region: ${{ env.Location }}
          resourceGroupName: ${{ env.LoggingResourceGroupName }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/logging/logging.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/modules/logging/parameters/logging.parameters.all.json
            parLogAnalyticsWorkspaceLocation=${{env.Location}}
            parAutomationAccountLocation=${{env.Location}}
            parLogAnalyticsWorkspaceName=${{ env.logAnalyticsWorkspaceName}}
            parDataCollectionRuleMDFCSQLName=${{ env.dataCollectionRuleMDFCSQLName}}
            parDataCollectionRuleChangeTrackingName=${{ env.dataCollectionRuleChangeTrackingName}}
            parDataCollectionRuleVMInsightsName=${{ env.dataCollectionRuleVMInsightsName}}
            parUserAssignedManagedIdentityName=${{ env.userAssignedManagedIdentityName}}
          deploymentName: create_logging-deploy-${{ env.runNumber }}
          failOnStdErr: false
  validate_preview_mgDiagSettings:
    runs-on: ubuntu-latest
    needs: [deploy_logging]
    name: Deploy MG Diag Settings - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get existing resources
        id: get_resources
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set -s "${{env.MgmtSubId}}"
            logAnalyticsWorkspaceResourceId=$(az monitor log-analytics workspace show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-log-analytics --query id)
            echo "$logAnalyticsWorkspaceResourceId"
            echo "logAnalyticsWorkspaceResourceId=$logAnalyticsWorkspaceResourceId" >> "$GITHUB_OUTPUT"
      - name: Deploy MG Diag Settings - Validation
        id: deploy_mgDiagSettings_validation
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/mgDiagSettingsAll.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/parameters/mgDiagSettingsAll.parameters.all.json
            parLogAnalyticsWorkspaceResourceId=${{ steps.get_resources.outputs.logAnalyticsWorkspaceResourceId}}
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_mgDiagSettings-validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy MG Diag Settings - Preview
        id: deploy_mgDiagSettings_preview
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/mgDiagSettingsAll.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/parameters/mgDiagSettingsAll.parameters.all.json
            parLogAnalyticsWorkspaceResourceId=${{ steps.get_resources.outputs.logAnalyticsWorkspaceResourceId}}
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_mgDiagSettings-preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_mgDiagSettings:
    runs-on: ubuntu-latest
    needs: [validate_preview_mgDiagSettings]
    environment: deploy
    name: Deploy MG Diag Settings - Deploy
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get existing resources
        id: get_resources
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set -s "${{env.MgmtSubId}}"
            logAnalyticsWorkspaceResourceId=$(az monitor log-analytics workspace show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-log-analytics --query id)
            echo "$logAnalyticsWorkspaceResourceId"
            echo "logAnalyticsWorkspaceResourceId=$logAnalyticsWorkspaceResourceId" >> "$GITHUB_OUTPUT"
      - name:  Deploy MG Diag Settings - Deploy
        id: deploy_mgDiagSettings_deploy
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/mgDiagSettingsAll.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/orchestration/mgDiagSettingsAll/parameters/mgDiagSettingsAll.parameters.all.json
            parLogAnalyticsWorkspaceResourceId=${{ steps.get_resources.outputs.logAnalyticsWorkspaceResourceId}}
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_mgDiagSettings-deploy-${{ env.runNumber }}
          failOnStdErr: false
  validate_preview_hubNetwork:
    runs-on: ubuntu-latest
    needs: [deploy_mgDiagSettings]
    name: Deploy Hub Network - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy HubNetwork RG - Validation
        id: deploy_hubNetworkRg_validation
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ env.ConnectivitySubId }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          parameters: parResourceGroupName=${{ env.HubNetworkResourceGroupName }} parLocation=${{ env.Location }}
          deploymentName: deploy_hubNetworkRg_validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Hub Network - Validation
        id: deploy_hubNetwork_validation
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.ConnectivitySubId }}
          region: ${{ env.Location }}
          resourceGroupName: ${{ env.HubNetworkResourceGroupName }}
          template: ./main/infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep
          parameters: >-
            ./main/deploy/hubNetworking.parameters.json
            parLocation=${{ env.Location }}
            parCompanyPrefix=${{ env.ManagementGroupPrefix }}
            parHubNetworkName=${{ env.ManagementGroupPrefix }}-hub-${{ env.Location }}
            parHubNetworkAddressPrefix=${{ env.HubNetworkAddressPrefix }}
            parAzBastionEnabled=false
            parDdosEnabled=false
            parAzFirewallEnabled=false
            parAzFirewallName=${{ env.ManagementGroupPrefix }}-azfw-${{ env.Location }}
            parAzFirewallPoliciesName=${{ env.ManagementGroupPrefix }}-azfwpolicy-${{ env.Location }}
            parHubRouteTableName=${{ env.ManagementGroupPrefix }}-hub-routetable-${{ env.Location }}
            parVpnGatewayEnabled=false
            parExpressRouteGatewayEnabled=false
            parPrivateDnsZoneAutoMergeAzureBackupZone=true
            parPrivateDnsZonesEnabled=true
            parPrivateDnsZones="['privatelink.file.core.windows.net', 'privatelink.wvd.microsoft.com']"
          deploymentName: deploy_hubNetwork_validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy HubNetwork RG - Preview
        id: deploy_hubNetworkRg_preview
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ env.ConnectivitySubId }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          parameters: parResourceGroupName=${{ env.HubNetworkResourceGroupName }} parLocation=${{ env.Location }}
          deploymentName: deploy_hubNetworkRg_validation-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
      - name: Deploy Hub Network - Preview
        id: deploy_hubNetwork_preview
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.ConnectivitySubId }}
          region: ${{ env.Location }}
          resourceGroupName: ${{ env.HubNetworkResourceGroupName }}
          template: ./main/infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep
          parameters: >-
            ./main/deploy/hubNetworking.parameters.json
            parLocation=${{ env.Location }}
            parCompanyPrefix=${{ env.ManagementGroupPrefix }}
            parHubNetworkName=${{ env.ManagementGroupPrefix }}-hub-${{ env.Location }}
            parAzBastionEnabled=false
            parDdosEnabled=false
            parAzFirewallEnabled=false
            parAzFirewallName=${{ env.ManagementGroupPrefix }}-azfw-${{ env.Location }}
            parAzFirewallPoliciesName=${{ env.ManagementGroupPrefix }}-azfwpolicy-${{ env.Location }}
            parHubRouteTableName=${{ env.ManagementGroupPrefix }}-hub-routetable-${{ env.Location }}
            parVpnGatewayEnabled=false
            parExpressRouteGatewayEnabled=false
            parPrivateDnsZoneAutoMergeAzureBackupZone=true
            parPrivateDnsZonesEnabled=true
            parPrivateDnsZones="['privatelink.file.core.windows.net', 'privatelink.wvd.microsoft.com']"
          deploymentName: deploy_hubNetwork_preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_hubNetwork:
    runs-on: ubuntu-latest
    needs: [validate_preview_hubNetwork]
    environment: deploy
    name: Deploy Hub Network - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy HubNetwork RG - Deployment
        id: deploy_hubNetworkRg_deployment
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ env.ConnectivitySubId }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/resourceGroup/resourceGroup.bicep
          parameters: parResourceGroupName=${{ env.HubNetworkResourceGroupName }} parLocation=${{ env.Location }}
          deploymentName: deploy_hubNetworkRg_deployment-${{ env.runNumber }}
          failOnStdErr: false
      - name: Deploy Hub Network - Deployment
        id: deploy_hubNetwork_deployment
        uses: azure/arm-deploy@v2
        with:
          scope: resourcegroup
          subscriptionId: ${{ env.ConnectivitySubId }}
          region: ${{ env.Location }}
          resourceGroupName: ${{ env.HubNetworkResourceGroupName }}
          template: ./main/infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep
          parameters: >-
            ./main/deploy/hubNetworking.parameters.json
            parLocation=${{ env.Location }}
            parCompanyPrefix=${{ env.ManagementGroupPrefix }}
            parHubNetworkName=${{ env.ManagementGroupPrefix }}-hub-${{ env.Location }}
            parHubNetworkAddressPrefix=${{ env.HubNetworkAddressPrefix }}
            parAzBastionEnabled=false
            parDdosEnabled=false
            parAzFirewallEnabled=false
            parAzFirewallName=${{ env.ManagementGroupPrefix }}-azfw-${{ env.Location }}
            parAzFirewallPoliciesName=${{ env.ManagementGroupPrefix }}-azfwpolicy-${{ env.Location }}
            parHubRouteTableName=${{ env.ManagementGroupPrefix }}-hub-routetable-${{ env.Location }}
            parVpnGatewayEnabled=false
            parExpressRouteGatewayEnabled=false
            parPrivateDnsZoneAutoMergeAzureBackupZone=true
            parPrivateDnsZonesEnabled=true
            parPrivateDnsZones="['privatelink.file.core.windows.net', 'privatelink.wvd.microsoft.com']"
          deploymentName: deploy_hubNetwork_deployment-${{ env.runNumber }}
          failOnStdErr: false
  validate_preview_subPlacement:
    runs-on: ubuntu-latest
    needs: [deploy_hubNetwork]
    name: Deploy Sub Placement - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Sub Placement - Validation
        id: deploy_subPlacement_validation
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/subPlacementAll.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/parameters/subPlacementAll.parameters.all.json
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
            parPlatformManagementMgSubs="['${{ env.MgmtSubId }}']"
            parPlatformConnectivityMgSubs="['${{ env.ConnectivitySubId }}']"
            parPlatformIdentityMgSubs="['${{ env.IdentitySubId }}']"
          deploymentName: deploy_subPlacement-validation-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Sub Placement - Preview
        id: deploy_subPlacement_preview
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/subPlacementAll.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/parameters/subPlacementAll.parameters.all.json
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
            parPlatformManagementMgSubs="['${{ env.MgmtSubId }}']"
            parPlatformConnectivityMgSubs="['${{ env.ConnectivitySubId }}']"
            parPlatformIdentityMgSubs="['${{ env.IdentitySubId }}']"
          deploymentName: deploy_subPlacement-preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_subPlacement:
    runs-on: ubuntu-latest
    needs: [validate_preview_subPlacement]
    environment: deploy
    name: Deploy Sub Placement - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Sub Placement - Deployment
        id: deploy_subPlacement_deployment
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/subPlacementAll.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/orchestration/subPlacementAll/parameters/subPlacementAll.parameters.all.json
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
            parPlatformManagementMgSubs="['${{ env.MgmtSubId }}']"
            parPlatformConnectivityMgSubs="['${{ env.ConnectivitySubId }}']"
            parPlatformIdentityMgSubs="['${{ env.IdentitySubId }}']"
          deploymentName: deploy_subPlacement-validation-${{ env.runNumber }}
          failOnStdErr: false
  validate_preview_DefPol_Assignment:
    runs-on: ubuntu-latest
    needs: [deploy_subPlacement]
    name: Deploy Default Policy Assignment - Validation and Preview
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get existing resources
        id: get_resources
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set -s "${{env.MgmtSubId}}"
            logAnalyticsWorkspaceResourceId=$(az monitor log-analytics workspace show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-log-analytics --query id)
            dataCollectionRuleVMInsightsId=$(az monitor data-collection rule show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-ama-vmi-dcr --query id )
            dataCollectionRuleChangeTrackingResourceId=$(az monitor data-collection rule show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-ama-ct-dcr --query id )
            dataCollectionRuleMDFCSQLId=$(az monitor data-collection rule show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-ama-mdfcsql-dcr --query id )
            userAssignedManagedIdentityId=$(az identity show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-logging-mi --query id)
            az account set -s "${{ env.ConnectivitySubId }}"
            privateDnsResourceGroupId=$(az group show --name ${{ env.HubNetworkResourceGroupName }} --query id)
            echo "$logAnalyticsWorkspaceResourceId"
            echo "$dataCollectionRuleVMInsightsId"
            echo "$dataCollectionRuleChangeTrackingResourceId"
            echo "$dataCollectionRuleMDFCSQLId"
            echo "$userAssignedManagedIdentityId"
            echo "$privateDnsResourceGroupId"
            echo "logAnalyticsWorkspaceResourceId=$logAnalyticsWorkspaceResourceId" >> "$GITHUB_OUTPUT"
            echo "dataCollectionRuleVMInsightsId=$dataCollectionRuleVMInsightsId" >> "$GITHUB_OUTPUT"
            echo "dataCollectionRuleChangeTrackingResourceId=$dataCollectionRuleChangeTrackingResourceId" >> "$GITHUB_OUTPUT"
            echo "dataCollectionRuleMDFCSQLId=$dataCollectionRuleMDFCSQLId" >> "$GITHUB_OUTPUT"
            echo "userAssignedManagedIdentityId=$userAssignedManagedIdentityId" >> $GITHUB_OUTPUT
            echo "privateDnsResourceGroupId=$privateDnsResourceGroupId" >> "$GITHUB_OUTPUT"
      - name: Deploy Default Policy Assignment - Validation
        id: deploy_defPolAssignment_validation
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/policy/assignments/alzDefaults/alzDefaultPolicyAssignments.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/modules/policy/assignments/alzDefaults/parameters/alzDefaultPolicyAssignments.parameters.all.json
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parDdosEnabled=false
            parDdosProtectionPlanId=''
            parLogAnalyticsWorkSpaceAndAutomationAccountLocation=${{env.Location}}
            parLogAnalyticsWorkspaceResourceId=${{ steps.get_resources.outputs.logAnalyticsWorkspaceResourceId}}
            parDataCollectionRuleVMInsightsResourceId=${{ steps.get_resources.outputs.dataCollectionRuleVMInsightsId }}
            parDataCollectionRuleChangeTrackingResourceId=${{ steps.get_resources.output.dataCollectionRuleChangeTrackingResourceId }}
            parDataCollectionRuleMDFCSQLResourceId=${{ steps.get_resources.outputs.dataCollectionRuleMDFCSQLId }}
            parUserAssignedManagedIdentityResourceId=${{ steps.get_resources.outputs.userAssignedManagedIdentityId }}
            parMsDefenderForCloudEmailSecurityContact=${{env.DefenderForCloudEmailSecurityContact}}
            parPrivateDnsResourceGroupId=${{ steps.get_resources.outputs.privateDnsResourceGroupId }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_defPolAssign_validate-${{ env.runNumber }}
          failOnStdErr: false
          deploymentMode: Validate
      - name: Deploy Default Policy Assignment - Preview
        id: deploy_defPolAssignment_preview
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/policy/assignments/alzDefaults/alzDefaultPolicyAssignments.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/modules/policy/assignments/alzDefaults/parameters/alzDefaultPolicyAssignments.parameters.all.json
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parDdosEnabled=false
            parDdosProtectionPlanId=''
            parLogAnalyticsWorkSpaceAndAutomationAccountLocation=${{env.Location}}
            parLogAnalyticsWorkspaceResourceId=${{ steps.get_resources.outputs.logAnalyticsWorkspaceResourceId}}
            parDataCollectionRuleVMInsightsResourceId=${{ steps.get_resources.outputs.dataCollectionRuleVMInsightsId }}
            parDataCollectionRuleChangeTrackingResourceId=${{ steps.get_resources.output.dataCollectionRuleChangeTrackingResourceId }}
            parDataCollectionRuleMDFCSQLResourceId=${{ steps.get_resources.outputs.dataCollectionRuleMDFCSQLId }}
            parUserAssignedManagedIdentityResourceId=${{ steps.get_resources.outputs.userAssignedManagedIdentityId }}
            parMsDefenderForCloudEmailSecurityContact=${{env.DefenderForCloudEmailSecurityContact}}
            parPrivateDnsResourceGroupId=${{ steps.get_resources.outputs.privateDnsResourceGroupId }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_defPolAssign_preview-${{ env.runNumber }}
          failOnStdErr: false
          additionalArguments: "--what-if"
  deploy_DefPol_Assignment:
    runs-on: ubuntu-latest
    needs: [validate_preview_DefPol_Assignment]
    environment: deploy
    name: Deploy Default Policy Assignment - Deployment
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout ALZ-Bicep Repo
        uses: actions/checkout@v4
        with:
          repository: Azure/ALZ-Bicep
          path: ALZ-Bicep
          ref: ${{ env.alzBicepRelease }}
      - name: Show env
        run: env | sort
      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Get existing resources
        id: get_resources
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account set -s "${{env.MgmtSubId}}"
            logAnalyticsWorkspaceResourceId=$(az monitor log-analytics workspace show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-log-analytics --query id)
            dataCollectionRuleVMInsightsId=$(az monitor data-collection rule show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-ama-vmi-dcr --query id )
            dataCollectionRuleChangeTrackingResourceId=$(az monitor data-collection rule show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-ama-ct-dcr --query id )
            dataCollectionRuleMDFCSQLId=$(az monitor data-collection rule show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-ama-mdfcsql-dcr --query id )
            userAssignedManagedIdentityId=$(az identity show --resource-group ${{ env.LoggingResourceGroupName }} --name alz-logging-mi --query id)
            az account set -s "${{ env.ConnectivitySubId }}"
            privateDnsResourceGroupId=$(az group show --name ${{ env.HubNetworkResourceGroupName }} --query id)
            echo "$logAnalyticsWorkspaceResourceId"
            echo "$dataCollectionRuleVMInsightsId"
            echo "$dataCollectionRuleChangeTrackingResourceId"
            echo "$dataCollectionRuleMDFCSQLId"
            echo "$userAssignedManagedIdentityId"
            echo "$privateDnsResourceGroupId"
            echo "logAnalyticsWorkspaceResourceId=$logAnalyticsWorkspaceResourceId" >> "$GITHUB_OUTPUT"
            echo "dataCollectionRuleVMInsightsId=$dataCollectionRuleVMInsightsId" >> "$GITHUB_OUTPUT"
            echo "dataCollectionRuleChangeTrackingResourceId=$dataCollectionRuleChangeTrackingResourceId" >> "$GITHUB_OUTPUT"
            echo "dataCollectionRuleMDFCSQLId=$dataCollectionRuleMDFCSQLId" >> "$GITHUB_OUTPUT"
            echo "userAssignedManagedIdentityId=$userAssignedManagedIdentityId" >> $GITHUB_OUTPUT
            echo "privateDnsResourceGroupId=$privateDnsResourceGroupId" >> "$GITHUB_OUTPUT"
      - name: Deploy Default Policy Assignment - Deployment
        id: deploy_defPolAssignment_deployment
        uses: azure/arm-deploy@v2
        with:
          scope: managementgroup
          managementGroupId: ${{ env.ManagementGroupPrefix }}${{ env.ManagementGroupSuffix }}
          region: ${{ env.Location }}
          template: ALZ-Bicep/infra-as-code/bicep/modules/policy/assignments/alzDefaults/alzDefaultPolicyAssignments.bicep
          parameters: >-
            ALZ-Bicep/infra-as-code/bicep/modules/policy/assignments/alzDefaults/parameters/alzDefaultPolicyAssignments.parameters.all.json
            parTopLevelManagementGroupPrefix=${{ env.ManagementGroupPrefix }}
            parDdosEnabled=false
            parDdosProtectionPlanId=''
            parLogAnalyticsWorkSpaceAndAutomationAccountLocation=${{env.Location}}
            parLogAnalyticsWorkspaceResourceId=${{ steps.get_resources.outputs.logAnalyticsWorkspaceResourceId}}
            parDataCollectionRuleVMInsightsResourceId=${{ steps.get_resources.outputs.dataCollectionRuleVMInsightsId }}
            parDataCollectionRuleChangeTrackingResourceId=${{ steps.get_resources.output.dataCollectionRuleChangeTrackingResourceId }}
            parDataCollectionRuleMDFCSQLResourceId=${{ steps.get_resources.outputs.dataCollectionRuleMDFCSQLId }}
            parUserAssignedManagedIdentityResourceId=${{ steps.get_resources.outputs.userAssignedManagedIdentityId }}
            parMsDefenderForCloudEmailSecurityContact=${{env.DefenderForCloudEmailSecurityContact}}
            parPrivateDnsResourceGroupId=${{ steps.get_resources.outputs.privateDnsResourceGroupId }}
            parTopLevelManagementGroupSuffix=${{ env.ManagementGroupSuffix }}
          deploymentName: deploy_defPolAssign_deployment-${{ env.runNumber }}
          failOnStdErr: false
    

  # rollback:
  #   runs-on: ubuntu-latest
  #   needs: deploy
  #   if: ${{ failure() }}
  #   steps:
  #     - run: echo "Here is where you'd perform the steps to roll back a failure."
